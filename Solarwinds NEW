import requests
import json
import urllib3
from orionsdk import SwisClient
import re
import pythonutil
  
class APIPlugin:
    _headers = {"Content-Type": "application/json",
                "Accept": "application/json"}
  
    def __init__(self, user, pwd, url):
        if re.search('http://(.+)', url):
            stripped = re.search('http://(.+)', url)
            url = stripped.group(1)
        url = url.replace('http://','')
        url = url.replace('https://','')
        self._swis = SwisClient(url, user, pwd)
 
    # API Plugin Test function definition. The sample test function random retrieves an incident number from ServiceNow to verify the connection.
    def _test(self):
        query = "SELECT nodeid FROM Orion.Nodes WHERE SysName LIKE '%'+@id+'%'"
        deviceName='pros-orion-05'
        result = str(self._query(query, deviceName))
        return result
 
    #Define a customized RESTful Get function template.         
    def _query(self, query, deviceName):
        #urlParams = {}
        #if 'urlParams' in param:
        #    urlParams=param['urlParams']
        try:
            response = self._swis.query(query,id=deviceName)
            return response
            
        except Exception as e:
            return str(e)

def extract_param(param):
    # The NetBrain initial parameters with customized fields.
    if isinstance(param, str):
        param = json.loads(param)
 
    #username, password, endpoint are build-in keywords in initial param.
    username = ''
    password = ''
    endpoint = ''
    #callParam is customized fields.
    callParam = {}
 
    return (username, password, endpoint, query, deviceName)


# Public function for API parser.
def getData(param):
    #username, password, endpoint, query , deviceName= extract_param(param)
    apiServerId = param['apiServerId']
    servInfo = pythonutil.GetApiServerInfo(apiServerId)
    username = servInfo['username']
    password = servInfo['password']
    endpoint = servInfo['endpoint']
    query = param.get("query")
    deviceName = param.get("deviceName")

    ap = APIPlugin(username, password, endpoint)
    #paramdict={"query":query, "deviceName": deviceName}
    rtn = ap._query(query, deviceName)
    return rtn
